# PagerDuty Incident Analysis Template

## Incident Information
- **Incident ID**: [Auto-filled by PagerDuty]
- **Service**: ads-demo-service
- **Severity**: [SEV-1 | SEV-2 | SEV-3]
- **Status**: [Triggered | Acknowledged | Resolved]
- **Triggered At**: [Timestamp]
- **Acknowledged At**: [Timestamp]
- **Resolved At**: [Timestamp]

## Service Details
- **Repository**: PagerDuty/ads-demo-service
- **Deployment**: Kubernetes (minikube)
- **Primary Language**: C
- **Resource Limits**: 64Mi memory, 250m CPU

## On-Call Team
- **Team**: [Team Name]
- **Primary On-Call**: [@username]
- **Secondary On-Call**: [@username]
- **Escalation Policy**: [Policy Name]

## Incident Timeline
```
[HH:MM:SS] - Pod starts consuming memory
[HH:MM:SS] - Memory usage reaches 64Mi limit
[HH:MM:SS] - Kubernetes OOMKills the pod
[HH:MM:SS] - PagerDuty incident triggered
[HH:MM:SS] - Pod restart initiated (CrashLoopBackOff)
```

## Recent Changes Analysis
**Timeframe**: 24 hours before incident

### Commits
- **Commit SHA**: [sha]
- **Author**: [@username]
- **Date**: [timestamp]
- **Files Changed**: 
  - `worker.c`
  - `infra/kubernetes/deployment.yaml`
  - Other files...
- **Deployment Correlation**: [Yes/No - deployed before incident]

### Pull Requests
- **PR #**: [number]
- **Title**: [title]
- **Merged**: [timestamp]
- **Deployments**: [deployment identifiers]

## Root Cause Analysis

### Affected Component
- **File**: `worker.c`
- **Function**: `controller()`
- **Lines**: 26-28

### Issue Description
Memory leak due to missing `free()` call. The `controller()` function allocates 10MB of memory in an infinite loop but never releases it.

**Code Analysis:**
```c
void controller() {
    while (1) {
        char *buffer = malloc(PAYLOAD_MB * 1024 * 1024 * sizeof(char));  // Line 26
        process_work(buffer);                                             // Line 27
        // MISSING: free(buffer);                                         // Should be here!
    }
}
```

### Evidence
- Kubernetes events: OOMKilled
- Pod restart count: [number]
- Memory usage pattern: Linear growth until limit
- Error messages: [if any]

### Confidence Level
**High Confidence** - Clear memory allocation without corresponding deallocation in an infinite loop.

## Impact Assessment
- **Service Availability**: Degraded (pod constantly restarting)
- **User Impact**: [Describe customer impact]
- **Duration**: [Time from trigger to resolution]
- **Affected Features**: All worker functionality

## Remediation

### Immediate Actions Taken
1. Acknowledged incident
2. Identified root cause
3. Prepared fix

### Proposed Fix
Add memory deallocation after buffer usage:

```c
void controller() {
    while (1) {
        char *buffer = malloc(PAYLOAD_MB * 1024 * 1024 * sizeof(char));
        process_work(buffer);
        free(buffer);  // FIX: Free allocated memory
    }
}
```

### Alternative Solutions
1. **Rollback**: Revert to previous stable version (if available)
2. **Mitigation**: Increase memory limit temporarily (not recommended - masks issue)
3. **Redesign**: Use static buffer or memory pool instead of dynamic allocation

### Recommended Action
Apply the fix by adding `free(buffer)` - minimal change with immediate impact.

## Fix PR Details
- **Title**: [Incident #ID] Fix memory leak in worker controller
- **Description**: Resolves memory leak causing OOMKilled incidents
- **Files Changed**: `worker.c`
- **Lines Changed**: +1
- **Testing**: Build and deploy, monitor memory usage
- **Rollback Plan**: Revert commit if issues arise

## Prevention Measures

### Short-term
- Add `free()` call to fix memory leak
- Deploy and monitor for 24 hours

### Long-term
- Implement memory leak detection in CI/CD (valgrind)
- Add unit tests for memory management
- Enable AddressSanitizer in development builds
- Implement resource usage monitoring and alerting
- Code review checklist: verify malloc/free pairs

## Post-Incident Actions
- [ ] Deploy fix
- [ ] Monitor service stability
- [ ] Update runbook if needed
- [ ] Conduct post-mortem meeting
- [ ] Update documentation
- [ ] Implement prevention measures
- [ ] Close incident

## Related Links
- [PagerDuty Incident URL]
- [GitHub PR for fix]
- [Deployment logs]
- [Monitoring dashboard]
- [Post-mortem document]

---
*This analysis was generated by PagerDuty MCP to assist with incident response and resolution.*
